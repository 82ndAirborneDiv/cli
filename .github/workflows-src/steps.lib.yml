#@ def steps_build():
name: Build
run: |
  echo "Branch: $GITHUB_HEAD_REF"
  if [[ "$GITHUB_HEAD_REF" == "master" ]]; then
    export BRANCH_OVERRIDE=unstable
  fi
  state run build
#@ end
---
#@ def steps_genupdate():
name: "Generate Update"
run: state run generate-update
#@ end

---
#@ def steps_installgo():
name: "Install Go"
uses: actions/setup-go@v2
with:
  go-version: ${{ matrix.go-version }}
#@ end
---
#@ def steps_installstate():
name: "Install State Tool"
run: |
  ./installers/install.sh -n -b master
  echo "::add-path::$HOME/.local/bin"
#@ end
---
#@ def steps_preprocess():
name: "Preprocess"
run: state run preprocess
#@ end
---
#@ def steps_inttest():
name: "Integration Tests"
run: go test -timeout 20m ./test/integration -v
#@ end
---
#@ def steps_uploadartifacts():
name: "Upload Artifacts"
uses: actions/upload-artifact@v2
with:
  name: build
  path: build/
#@ end
---
#@ def steps_downloadartifacts():
name: "Download Artifacts"
uses: actions/download-artifact@v2
with:
  name: build
  path: build/
#@ end
---
#@ def steps_deploy():
name: "Deploy"
run: state run deploy-updates
env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#@ end